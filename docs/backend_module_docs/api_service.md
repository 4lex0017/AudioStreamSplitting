# API Service

This class provides utilities for identifying songs using various song recognition APIs. Currently, the [Shazam API](https://rapidapi.com/apidojo/api/shazam) and [AcoustID](https://acoustid.org/) are supported.

To aid in finding segmentation errors, the service is stateful. The currently identified song as well as the last one are stored to allow concatenating segments in case the splitting was too eager.

An example for the general workflow of the API service can be found in ``identify_all_from_generator``.

## Contents

Classes:

- [``SongOptionResult``](#songoptionresult)

Public functions:

- [``identify_all_from_generator``](#identify_all_from_generator)
- [``reset_service_state``](#reset_service_state)
- [``get_last_song``](#get_last_song)
- [``get_final_song``](#get_final_song)
- [``get_song_options``](#get_song_options)

Private functions:

- [``_song_export``](#_song_export)
- [``_check_song_extended_or_finished``](#_check_song_extended_or_finished)
- [``_get_overlapping_metadata_values``](#_get_overlapping_metadata_values)
- [``_create_fingerprint``](#_create_fingerprint)
- [``_get_api_song_data_acoustid``](#_get_api_song_data_acoustid)
- [``_store_finished_song``](#_store_finished_song)

## Classes

### SongOptionResult

Enum containing all possible results of ``get_song_options``:

- ``SONG_EXTENDED``: The previous and current song segments are the same song. This happens if the segmentation algorithm split a song in the middle. The previous segment has been extended to include the current one.
- ``SONG_FINISHED``: The previous and current song segments are different songs. The previous segment has been stored in the ``last_song_*`` variables and can be retrieved using ``get_last_song``.
- ``SONG_MISMATCH``: The current song segment is recognised as a different song in the beginning and end. This happens if the segmentation algorithm didn't detect a change of songs. To solve this, the front-end should prompt the user to manually place the missing split. The previous segment has been stored in the ``last_song_*`` variables and can be retrieved using ``get_last_song``.
- ``SONG_NOT_RECOGNISED``: The current song segment couldn't be recognised. This happens if none of the song recognition APIs the user provided API keys for know the given song. The previous segment has been stored in the ``last_song_*`` variables and can be retrieved using ``get_last_song``.

## Public functions

### identify_all_from_generator

Identify all song segments provided by a generator, which should be created by ``modules/segmentation.py``.

#### identify_all_from_generator:Arguments

- ``generator: Generator``: A generator (generated by ``modules/segmentation.py``) that provides tuples of song data as ``((segment:np.ndarray, samplerate: float), offset: float, duration: float)``. The first provided tuple is only left for historic reasons and should be refactored out eventually.
- ``file_path: str``: The path to the analysed file.

#### identify_all_from_generator:Returns

Tuple ``(segments, mismatch_offsets)``.

- ``segments`` contains all the identified segments, formatted as a ``dict`` with the keys ``offset`` for the segment start, ``duration`` for the segment duration and ``metadataOptions`` for the metadata options.
- ``mismatch_offsets`` contains all ``offset`` values from ``segments`` where [``SongOptionResult.SONG_MISMATCH``](#songoptionresult) occurred.

### reset_service_state

Reset the ``current_song_*`` and ``last_song_*`` variables. This should be called before starting to analyze a new file when not using [``identify_all_from_generator``](#identify_all_from_generator).

#### reset_service_state:Arguments

#### reset_service_state:Returns

### get_last_song

Retrieve a finished song. This should be called whenever [``get_song_options``](#get_song_options) returns [``SongOptionResult.SONG_FINISHED``](#songoptionresult), except for the first time (as it will then contain empty metadata).

#### get_last_song:Arguments

#### get_last_song:Returns

A ``dict`` with the keys ``offset`` for the segment start, ``duration`` for the segment duration and ``metadataOptions`` for the metadata options.

### get_final_song

Retrieve the final song. This should be called after calling [``get_song_options``](#get_song_options) for the last time for a file. This will also reset the service state using [``reset_service_state``](#reset_service_state).

#### get_final_song:Arguments

#### get_final_song:Returns

A ``dict`` with the keys ``offset`` for the segment start, ``duration`` for the segment duration and ``metadataOptions`` for the metadata options.

### get_song_options

Call the song recognition APIs the user has provided an API key for and attempt to identify the given segment of the given file.

#### get_song_options:Arguments

- ``offset: float``: The offset at which the segment begins, in seconds.
- ``duration: float``: The duration of the segment, in seconds.
- ``file_path: str``: The path to the analysed file.

#### get_song_options:Returns

[``SongOptionResult``](#songoptionresult) indicating the new state of the service.

## Private functions

While these functions aren't "private" in the sense that they cannot be accessed from the outside, they should not be called from outside this file.

### _song_export

Format the given offset, duration and metadata as a dict for the API. This is used for formatting for [``get_last_song``](#get_last_song) and [``get_final_song``](#get_final_song).

#### _song_export:Arguments

- ``offset: float``: The offset at which the segment begins, in seconds.
- ``duration: float``: The duration of the segment, in seconds.
- ``metadata_options: list``: A list of the metadata options, formatted as dicts.

#### _song_export:Returns

A ``dict`` with the keys ``offset`` for the segment start, ``duration`` for the segment duration and ``metadataOptions`` for the metadata options.

### _check_song_extended_or_finished

Check if the metadata options of the analyzed segment match those of the previous segment. Store the finished song if applicable.

#### _check_song_extended_or_finished:Arguments

- ``offset: float``: The offset at which the analyzed segment begins, in seconds.
- ``duration: float``: The duration of the analyzed segment, in seconds.
- ``metadata_options: list``: A list of the metadata options for the analyzed segment, formatted as dicts.

#### _check_song_extended_or_finished:Returns

[``SongOptionResult``](#songoptionresult) indicating whether the previous segment was extended or finished.

### _get_overlapping_metadata_values

From two sets of metadata, get all that have the same artist and title. If either of the sets is empty, return the other set.

#### _get_overlapping_metadata_values:Arguments

- ``metadata1: list``: First list of metadata to compare.
- ``metadata2: list``: Second list of metadata to compare.

#### _get_overlapping_metadata_values:Returns

A ``list`` of the matching metadata options.

### _create_fingerprint

Create a [chromaprint/AcoustID](https://github.com/acoustid/chromaprint) fingerprint for the given audio data in order to identify it using [AcoustID](https://acoustid.org).

As of current, this works by writing the data to a temporary file and using the ``fpcalc`` command line tool to generate the fingerprint. If it becomes feasible to build and distribute DLL versions of ``chromaprint`` for all target platforms, this should be refactored to use that instead.

#### _create_fingerprint:Arguments

- ``song_data: numpy.ndarray`` The song data to generate a fingerprint from.
- ``samplerate: int`` The sample rate of the song data.

#### _create_fingerprint:Returns

Tuple ``(song_duration, fingerprint)``

### _get_api_song_data_acoustid

Get data about the provided fingerprint from the [AcoustID](https://acoustid.org) API.

#### _get_api_song_data_acoustid:Arguments

- ``fingerprint: str`` The fingerprint generated using [``create_fingerprint``](#_create_fingerprint) or other usage of [chromaprint](https://github.com/acoustid/chromaprint).
- ``fingerprint_duration: float`` The duration of the fingerprinted data, in seconds.

#### _get_api_song_data_acoustid:Returns

A ``list`` of ``dict``s containing the results. The ``dict``s have the keys ``"artist"`` for the artist name and ``"title"`` for the song title.

### _store_finished_song

Store the previous segment's data in the ``last_song_*`` variables and replace the ``current_song_*`` variables with the provided data. This is used to correctly change the service's state in [``get_song_options``](#get_song_options) and functions called by it.
